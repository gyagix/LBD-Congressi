<!-- Includi Alpine.js -->
<script src="https://unpkg.com/alpinejs" defer></script>

<!-- Assicurati che il tuo file app.js per Equipment sia caricato qui -->
<!-- <script src="app.js"></script> -->

<div x-data="equipmentApp()" x-init="init()">
  <h2>Gestione Equipment</h2>
  <div class="filter-list">
    <button class="button-icon button-add" @click="newEquipment()">
      <svg width="24" height="24" viewBox="0 0 24 24" aria-label="Nuovo" role="img" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12h14" />
      </svg>
    </button>
    <button class="button-icon button-add" @click="openEditTableListShowHide()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12c-1.8 3-5 5-9 5s-7.2-2-9-5c1.8-3 5-5 9-5s7.2 2 9 5z" />
        <line x1="3" y1="3" x2="20" y2="20" />
      </svg>
    </button>
    <input class="input-search" type="text" placeholder="Cerca..." x-model="search" @input="filterEquipments" style="margin-bottom: 1em; width: 100%; padding: 6px;" />
  </div>

  <table id="tableList" class="table-list">
    <thead>
      <tr>
        <th>&nbsp;</th>
        <template x-for="field in fields" :key="field.name">
            <th :data-name="field.name" @click="sortBy(field.name)" x-text="field.label"></th>
        </template>
        <th>Immagine</th>
        <th>&nbsp;</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="equipment in filteredEquipments" :key="equipment.Id">
        <tr>
          <td>
            <button @click="editEquipment(equipment)">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20h9" />
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
              </svg>
            </button>
          </td>
          <template x-for="field in fields" :key="field.name">
            <td :data-name="field.name" x-text="equipment[field.name]"></td>
          </template>
          <td>
            <img x-if="equipment.Image" :src="equipment.Image" alt="Anteprima" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
          </td>
          <td>
            <button @click="deleteEquipment(equipment.Id)">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18" />
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                <path d="M10 11v6M14 11v6" />
              </svg>
            </button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>

  <div class="overlay overlayhidden" id="overlayContainer">
    <div class="modelContent modelContentHidden" id="equipmentEditContainer">
      <form @submit.prevent="saveEquipment" style="margin-bottom:1em;">
        <input type="hidden" x-model="form.Id" />

        <div>
          <label>Titolo</label>
          <input type="text" x-model="form.Title" required />
        </div>

        <div>
          <label>Identification Number</label>
          <input type="text" x-model="form.IdentificationNumber" required />
        </div>

        <div>
          <label>Descrizione Modello</label>
          <input type="text" x-model="form.ModelDescription" />
        </div>
        
        <div>
          <label>Parent Equipment</label>
          <select x-model="form.ParentEquipmentID">
              <option :value="null">— Nessuno —</option>
              <template x-for="parent in parentEquipmentOptions.filter(p => p.Id !== form.Id)" :key="parent.Id">
                  <option :value="parent.Id" x-text="`${parent.Titolo} (${parent.IdentificationNumber})`"></option>
              </template>
          </select>
        </div>

        <div>
          <label>Numero Seriale</label>
          <input type="text" x-model="form.SerialNumber" />
        </div>

        <div>
          <label>Gruppo</label>
          <input type="text" x-model="form.Groupcode" />
        </div>

        <div>
          <label>Tipo Packaging</label>
          <input type="text" x-model="form.PackagingTypeCode" />
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <div>
                <label>Altezza (m)</label>
                <input type="number" step="0.01" x-model.number="form.Height" />
            </div>
            <div>
                <label>Lunghezza (m)</label>
                <input type="number" step="0.01" x-model.number="form.Length" />
            </div>
            <div>
                <label>Larghezza (m)</label>
                <input type="number" step="0.01" x-model.number="form.Width" />
            </div>
            <div>
                <label>Peso (kg)</label>
                <input type="number" step="0.01" x-model.number="form.Weight" />
            </div>
        </div>

        <div>
          <label>Dettagli</label>
          <textarea x-model="form.Details"></textarea>
        </div>

        <div>
          <label>URL Immagine</label>
          <input type="text" x-model="form.Image" placeholder="Inserisci l'URL dell'immagine">
        </div>

        <!-- Anteprima Immagine -->
        <div x-show="form.Image" style="grid-column: 1 / -1; margin-top: 10px;">
          <label>Anteprima Immagine</label>
          <img :src="form.Image" alt="Anteprima" style="max-width: 150px; max-height: 150px; display: block; border-radius: 4px; border: 1px solid #ddd;">
        </div>

        <div>
          <button class="modalContentButton" type="submit">
            <span x-text="form.Id ? 'Aggiorna Equipment' : 'Aggiungi Equipment'"></span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
              <polyline points="17 21 17 13 7 13 7 21" />
              <polyline points="7 3 7 8 15 8" />
            </svg>
          </button>
        </div>
        <div>
          <button @click="closeModalEdit" type="button" title="Chiudi" class="modalContentButton">
            Chiudi
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>
      </form>
    </div>

    <div id="divLoading" class="loading-box loading-hide">
      <span class="close-btn" @click="hideLoading">&times;</span>
      <p class="loading-text">Salvataggio in corso...</p>
      <svg class="spinner" viewBox="0 0 50 50">
        <circle cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
      </svg>
    </div>

    <div id="editVisibilityTableCols" class="modalShowHideTableCols modalShowHideTableColsHidden">
      <h3>Mostra/Nascondi colonne</h3>
      <label class="checkbox-item">
        <input type="checkbox" x-model="tableListCkAllChecked" @change="editTableListToggleAll()">
        <span>Seleziona/Togli tutti</span>
      </label>
      <div class="checkbox-list-columns">
        <template x-for="(field, index) in fields" :key="field.name">
          <label class="checkbox-item">
            <input type="checkbox" x-model="field.showInTableList">
            <span x-text="field.label"></span>
          </label>
        </template>
      </div>
      <div class="modal-actions">
        <button class="btn" @click="saveTableListShowHide()">Conferma e chiudi</button>
      </div>
    </div>
  </div>

  <div id="divNotification" class="notification">
    <span id="notifMsg"></span>
    <span class="close-btn" @click="hideNotification">&times;</span>
  </div>
</div>