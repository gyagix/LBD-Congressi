
<div x-data="projectApp()" x-init="init()">
  	<h2>Gestione Progetti</h2>
  	<div class="filter-list">
		<button class="button-icon button-add" @click="newProject(null)">
			<svg width="24" height="24" viewBox="0 0 24 24" aria-label="Nuovo" role="img"
				fill="none" stroke="#000000" stroke-width="6" stroke-linecap="round" stroke-linejoin="round">
				<path d="M12 5v14M5 12h14"/>
			</svg>
		</button>
		<button class="button-icon button-add" @click="openEditTableListShowHide()">
			<svg xmlns="http://www.w3.org/2000/svg"
				width="20" height="20" viewBox="0 0 24 24"
				fill="none" stroke="#000000" stroke-width="1"
				stroke-linecap="round" stroke-linejoin="round">               
			<!-- occhio sbarrato -->
			<path d="M21 12c-1.8 3-5 5-9 5s-7.2-2-9-5c1.8-3 5-5 9-5s7.2 2 9 5z"/>
			<line x1="3" y1="3" x2="20" y2="20"/>
			</svg>
		</button>
		<input
			class="input-search"
			type="text"
			placeholder="Cerca..."
			x-model="search"
			@input="filterProjects"
			style="margin-bottom: 1em; width: 100%; padding: 6px;"
		/>
	</div>
	
    <div class="list-scroll" id="list-scroll">
		<table id="tableList" class="table-list">
			<thead>
				<tr>
					<th>&nbsp;</th>
					<th>&nbsp;</th>
					<th data-name="Id" @click="sortBy('Id')">ID</th>
					<th data-name="ProjectCode" @click="sortBy('ProjectCode')">Codice</th>
					<th data-name="ProjectDescription" @click="sortBy('ProjectDescription')">Descrizione</th>
					<th data-name="TipoProgetto" @click="sortBy('TipoProgetto')">Tipo</th>
					<th data-name="Anno" @click="sortBy('Anno')">Anno</th>
					<th data-name="VenueName" @click="sortBy('VenueName')">Venue</th>
					<th data-name="Designer" @click="sortBy('Designer')">Designer</th>
					<th>&nbsp;</th>
				</tr>
			</thead>
			<tbody>
				<template x-for="item in filteredProjects" :key="item.Id">
					<tr>
						<td class="">
							<button @click="editProject(item)">
								<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
										viewBox="0 0 20 20" fill="none" stroke="#000000"
										stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
									<path d="M12 20h9"/>
									<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
								</svg>
							</button>
						</td>
						<td>
							<!-- Accanto al bottone Modifica -->
							<button @click="openAssociations(item)" title="Associa Eventi e Spedizioni">
								<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
									viewBox="0 0 24 24" fill="none" stroke="#000000"
									stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
									<circle cx="18" cy="5" r="3"/>
									<circle cx="6" cy="12" r="3"/>
									<circle cx="18" cy="19" r="3"/>
									<line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
									<line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
								</svg>
							</button>
						</td>
						<td data-name="Id" x-text="item.Id"></td>
						<td data-name="ProjectCode" x-text="item.ProjectCode"></td>
						<td data-name="ProjectDescription" x-text="item.ProjectDescription"></td>
						<td data-name="TipoProgetto" x-text="item.TipoProgetto"></td>
						<td data-name="Anno" x-text="item.Anno"></td>
						<td data-name="VenueName" x-text="item.Venue.VenueName"></td>
						<td data-name="Designer" x-text="item.Designer.Cognome + ' ' + item.Designer.Nome"></td>
						<td>
							<button @click="deleteProject(item.Id)">
								<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
									viewBox="0 0 20 20" fill="none" stroke="#000000"
									stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
									<path d="M3 6h18"/>
									<path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
									<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
									<path d="M10 11v6M14 11v6"/>
								</svg>
							</button>
						</td>
					</tr>
				</template>
			</tbody>
		</table>
	</div>


	<div class="overlay overlayhidden" id="overlayContainer">
		<div class="modelContent modelContentHidden" id="editContainer">
			<form @submit.prevent="saveProject" style="margin-bottom:1em;">
				<input type="hidden" x-model="form.Id" />
				<div>
					<label>Venue</label>
					<select x-model="form.VenueId" @change="updateCodeVenue">
						<option value="">— Seleziona —</option>
						<template x-for="venue in venueOptions" :key="venue.Id">
							<option :value="venue.Id" x-text="venue.VenueName + ' (' + venue.Code + ')'"></option>
						</template>
					</select>
				</div>
				<div>
					<label>Designer</label>
					<select x-model="form.DesignerId" @change="updateDesigner">
						<option value="">— Seleziona —</option>
						<template x-for="designer in designerOptions" :key="designer.Id">
							<option :value="designer.Id" x-text="designer.Cognome + ' ' + designer.Nome"></option>
						</template>
					</select>
				</div>				
				
				<div>
					<label>Tipo progetto</label>
					<select x-model="form.TipoProgetto">
					<option value="">— Seleziona —</option>
					<template x-for="t in typeOptions" :key="t">
						<option :value="t" x-text="t"></option>
					</template>
					</select>
				</div>


				<div>
					<label>Anno</label>
					<input type="number" x-model="form.Anno" required />
				</div>

				
				<div>
					<label>Codice Progetto</label>
					<input type="text" x-model="form.ProjectCode" required />
				</div>

				<div>
					<label>Descrizione Progetto</label>
					<input type="text" x-model="form.ProjectDescription" required />
				</div>



				<div class="modalContainerContentButtons btn-group">
					<button class="modalContentButton" type="submit">
						<span x-text="form.Id ? 'Aggiorna Progetto' : 'Aggiungi Progetto'"></span>
						<svg xmlns="http://www.w3.org/2000/svg" 
							width="24" height="24" viewBox="0 0 24 24" 
							fill="none" stroke="currentColor" stroke-width="2" 
							stroke-linecap="round" stroke-linejoin="round">
							<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
							<polyline points="17 21 17 13 7 13 7 21"/>
							<polyline points="7 3 7 8 15 8"/>
						</svg>

					</button>
					<button @click="closeModalEdit"
							type="button"
							title="Chiudi"
							class="modalContentButton">
							Chiudi senza salvare
							<svg xmlns="http://www.w3.org/2000/svg" 
								width="24" height="24" viewBox="0 0 24 24" 
								fill="none" stroke="currentColor" stroke-width="2" 
								stroke-linecap="round" stroke-linejoin="round">
								<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
								<polyline points="16 17 21 12 16 7"/>
								<line x1="21" y1="12" x2="9" y2="12"/>
							</svg>
						</button>
				</div>
			</form>
		</div>

  		<div id="divLoading" class="loading-box loading-hide">
            <span class="close-btn" @click="hideLoading">&times;</span>
            <p class="loading-text">Salvataggio in corso...</p>
            <svg class="spinner" viewBox="0 0 50 50">
                <circle
                    cx="25" cy="25" r="20"
                    fill="none" stroke-width="5">
                </circle>
            </svg>
        </div>

        <div id="editVisibilityTableCols" class="modalShowHideTableCols modalShowHideTableColsHidden" >
            <h3>Mostra/Nascondi colonne</h3>

            <!-- Checkbox Seleziona/Togli tutti -->
            <label class="checkbox-item">
                <input type="checkbox" x-model="tableListCkAllChecked" />
                <span>Seleziona/Togli tutti</span>
            </label>

            <div class="checkbox-list-columns">
                <template x-for="(field, index) in fields" :key="field.name">
                    <label class="checkbox-item">
                        <input type="checkbox" x-model="field.showInTableList">
                        <span x-text="field.label"></span>
                    </label>
                </template>
            </div>

            <div class="modal-actions">
                <button class="btn" @click="saveTableListShowHide()">Conferma e chiudi</button>
            </div>
        </div>

		<!-- MODAL ASSOCIAZIONI -->
		<div class="modelContentAssociations modelContentAssociationsHidden" id="editContainerAssociations">
			<div class="model">
				<div class="modelHeader">
					<h3 x-text="assoc.project ? `Associa Eventi e Spedizioni a Progetto ${assoc.project.ProjectCode || ''} - ${assoc.project.ProjectDescription || ''}` : ''"> </h3>
				</div>
				<div class="linked-data-container">						
					<div class="section-container">
						<!-- EVENTI DISPONIBILI -->
							<div class="section-header">
								<h4>Eventi (filtrati per venue)</h4>
								<input type="text" placeholder="Cerca evento…" x-model="assoc.events.search" @input.debounce.300ms="filterEvents()" size="30">
								<button class="section-button" @click="reloadEvents()" title="Ricarica">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 28 28" fill="none" 
										stroke="#000000" stroke-width="2" 
										stroke-linecap="round" 
										stroke-linejoin="round">
										<!-- Freccia -->
										<polyline points="23 4 23 10 17 10"/>
										<!-- Curva della ricarica -->
										<path d="M20.49 20.49a9 9 0 1 1 0-12.73"/>
									</svg>
								</button>
							</div>
							
							<div class="section-content">
								<table>
									<thead>
										<tr><th>#</th><th>ID</th><th>Nome</th><th>Data</th><th></th></tr>
									</thead>
									<tbody>
										<template x-for="(ev, i) in assoc.events.availableFiltered" :key="ev.Id">
											<tr>
											<td x-text="i+1"></td>
											<td x-text="ev.Id"></td>
											<td x-text="ev.EventName || ''"></td>p
											<td x-text="formatDate(ev.DateStart) + (ev.DateEnd ? (' → ' + formatDate(ev.DateEnd)) : '')"></td>
											<td>
												<button class="section-button" @click="addEvent(ev)">
													<!-- Icona Aggiungi (cerchio con +) -->
													<svg role="img" aria-label="Aggiungi elemento" xmlns="http://www.w3.org/2000/svg" 
															width="20" height="20" viewBox="0 0 24 24" 
															fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
															stroke-linejoin="round">
														<title>Aggiungi</title>
														<circle cx="12" cy="12" r="10"></circle>
														<line x1="12" y1="8" x2="12" y2="16"></line>
														<line x1="8" y1="12" x2="16" y2="12"></line>
													</svg>
												</button>
											</td>
											</tr>
										</template>
									</tbody>
								</table>
							</div>
					</div>

					<div class="section-container">
						<!-- EVENTI ASSOCIATI -->
							<div class="section-header">
								<h4>Eventi associati</h4>
								<div></div>
								<div></div>
							</div>
							<div class="section-content">
								<table>
									<thead>
									<tr><th>ID</th><th>Nome</th><th>Inizio</th><th>Fine</th><th></th></tr>
									</thead>
									<tbody>
									<template x-for="link in assoc.events.linked" :key="link._key">
										<tr>
											<td x-text="link.EventId"></td>
											<td x-text="link._display || ''"></td>
											<td x-text="formatDate(link.PeriodBegins) || ''"></td>
											<td x-text="formatDate(link.PeriodEnds) || ''"></td>
											<td>
												<button class="section-button" @click="removeEvent(link)">
													<svg role="img" aria-label="Rimuovi elemento" xmlns="http://www.w3.org/2000/svg" 
														width="20" height="20" viewBox="0 0 24 24" 
														fill="none" 
														stroke="#000000" stroke-width="2" 
														stroke-linecap="round" stroke-linejoin="round">
														<title>Rimuovi</title>
														<circle cx="12" cy="12" r="10"></circle>
														<line x1="8" y1="12" x2="16" y2="12"></line>
													</svg>
												</button>
											</td>
										</tr>
									</template>
									</tbody>
								</table>
							</div>
					</div>

						<!-- SPEDIZIONI DISPONIBILI -->
					<div class="section-container">
							<div class="section-header">
								<h4>Spedizioni (filtrate per venue)</h4>
								<input type="text" placeholder="Cerca spedizione…" x-model="assoc.shipments.search" @input.debounce.300ms="filterShipping()" size="30">
								<button class="section-button" @click="reloadShipping()" title="Ricarica">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 28 28" fill="none" 
										stroke="#000000" stroke-width="2" 
										stroke-linecap="round" 
										stroke-linejoin="round">
										<!-- Freccia -->
										<polyline points="23 4 23 10 17 10"/>
										<!-- Curva della ricarica -->
										<path d="M20.49 20.49a9 9 0 1 1 0-12.73"/>
									</svg>
								</button>					
							</div>

							<div class="section-content">
								<table>
									<thead>
										<tr><th>#</th><th>ID</th><th>Nome</th><th>Data</th><th></th></tr>
									</thead>
									<tbody>
										<template x-for="(sh, i) in assoc.shipments.availableFiltered" :key="sh.Id">
											<tr>
											<td x-text="i+1"></td>
											<td x-text="sh.Id"></td>
											<td x-text="sh.ShipmentName || ''"></td>
											<td x-text="formatDate(sh.PickupDate) + (sh.DeliveryDate ? (' → ' + formatDate(sh.DeliveryDate)) : '')"></td>
											<td>
												<button class="section-button" @click="addShipment(sh)">
													<!-- Icona Aggiungi (cerchio con +) -->
													<svg role="img" aria-label="Aggiungi elemento" xmlns="http://www.w3.org/2000/svg" 
															width="20" height="20" viewBox="0 0 24 24" 
															fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
															stroke-linejoin="round">
														<title>Aggiungi</title>
														<circle cx="12" cy="12" r="10"></circle>
														<line x1="12" y1="8" x2="12" y2="16"></line>
														<line x1="8" y1="12" x2="16" y2="12"></line>
													</svg>
												</button>
											</td>
											</tr>
										</template>
									</tbody>
								</table>
							</div>
					</div>
					
					

						<!-- SPEDIZIONI ASSOCIATE -->
					<div class="section-content">
						<div class="section-header">
							<h4>Spedizioni associate</h4>
							<div></div>	
							<div>	</div>
						</div>								
						<div class="section-content">
							<table>
								<thead>
								<tr><th>ID</th><th>Nome</th><th>Inizio</th><th>Fine</th><th></th></tr>
								</thead>
								<tbody>
								<template x-for="link in assoc.shipments.linked" :key="link._key">
									<tr>
										<td x-text="link.ShippingId"></td>
										<td x-text="link._display || ''"></td>
										<td x-text="formatDate(link.PeriodBegins) || ''"></td>
										<td x-text="formatDate(link.PeriodEnds) || ''"></td>
										<td>
											<button class="section-button" @click="removeShipment(link)">
												<svg role="img" aria-label="Rimuovi elemento" xmlns="http://www.w3.org/2000/svg" 
													width="20" height="20" viewBox="0 0 24 24" 
													fill="none" 
													stroke="#000000" stroke-width="2" 
													stroke-linecap="round" stroke-linejoin="round">
													<title>Rimuovi</title>
													<circle cx="12" cy="12" r="10"></circle>
													<line x1="8" y1="12" x2="16" y2="12"></line>
												</svg>
											</button>
										</td>
									</tr>
								</template>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="container-buttons btn-group">
					<button class="btn btn-primary" @click="saveAssociations()">
						Salva le modifiche
						<svg xmlns="http://www.w3.org/2000/svg" 
							width="24" height="24" viewBox="0 0 24 24" 
							fill="none" stroke="currentColor" stroke-width="2" 
							stroke-linecap="round" stroke-linejoin="round">
							<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
							<polyline points="17 21 17 13 7 13 7 21"/>
							<polyline points="7 3 7 8 15 8"/>
						</svg>
					</button>
					<button class="btn " @click="resetAssociations()">
						Annulla modifiche
						<svg xmlns="http://www.w3.org/2000/svg"
							width="24" height="24" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2"
							stroke-linecap="round" stroke-linejoin="round" role="img" aria-hidden="false">
							
							<!-- X disegnata all’interno del documento -->
							<line x1="6" y1="9" x2="12" y2="15"/>
							<line x1="12" y1="9" x2="6" y2="15"/>
						</svg>
					</button>
					<button class="btn " @click="closeAssociations()">
						Chiudi senza salvare
						<svg xmlns="http://www.w3.org/2000/svg" 
							width="24" height="24" viewBox="0 0 24 24" 
							fill="none" stroke="currentColor" stroke-width="2" 
							stroke-linecap="round" stroke-linejoin="round">
							<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
							<polyline points="16 17 21 12 16 7"/>
							<line x1="21" y1="12" x2="9" y2="12"/>
						</svg>
					</button>
				</div>
			</div>

    	</div>
	</div>
    <div id="divNotification" class="notification">
        <span id="notifMsg"></span>
        <span class="close-btn" @click="hideNotification">&times;</span>
    </div>
</div>
